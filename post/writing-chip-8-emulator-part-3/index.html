<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Пишем эмулятор CHIP-8. Часть 3: Примеры программ | Emunix</title>



<link href="https://emunix.org/index.xml" rel="alternate" type="application/rss+xml" title="Emunix" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://emunix.org/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://emunix.org/post/writing-chip-8-emulator-part-3/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://emunix.org/">
          <h1 id="nav-heading" class="title is-4">Emunix</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/btimofeev'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/btimofeev'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:btimofeev@emunix.org'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/dev">#dev</a>



  
  | <a class="subtitle is-6" href="/tags/emulation">#emulation</a>
  

      
    </div>
    <h2 class="subtitle is-6">15 апреля 2012</h2>
    <h1 class="title">Пишем эмулятор CHIP-8. Часть 3: Примеры программ</h1>
    
    <div class="content">
      <p>В <a href="/post/writing-chip-8-emulator-part-2/">прошлой статье</a> мы рассмотрели опкоды CHIP-8. Сегодня попробуем написать несколько простых демонстрационных программ для него.</p>
<h2 id="chipper">Chipper</h2>
<p>Для компиляции исходного кода нам потребуется ассемблер Chipper, автором которого является Hans Christian Egeberg. Скачать можно по ссылке <a href="http://www.hpcalc.org/hp48/pc/programming/chipper.zip">http://www.hpcalc.org/hp48/pc/programming/chipper.zip</a></p>
<p>В архиве лежат 3 файла:</p>
<ul>
<li>CHIPPER.EXE - ассемблер для DOS (возможно запустится в Windows. Если нет, то используйте <a href="http://www.dosbox.com/">DosBox</a>)</li>
<li>CHIPPER.DOC - документация в формате txt (а не в doc как указано)</li>
<li>CHIPPER.C - исходный код программы (пригодится пользователям альтернативных операционных систем)</li>
</ul>
<p>Для линукса Chipper компилируется следующей командой:</p>
<pre><code>gcc CHIPPER.C -o chipper
</code></pre><p>Для Arch Linux готовый пакет лежит в <a href="https://aur.archlinux.org/packages.php?ID=57427">AUR</a>.</p>
<p>После этого бинарник для CHIP-8 собирается следующей командой:</p>
<pre><code>chipper ЦЕЛЬ ИСХОДНИК
</code></pre><p>где ЦЕЛЬ - название файла игры который появится в результате компиляции, далее запускаем его в эмуляторе.<br>
ИСХОДНИК - путь к файлу с исходным кодом игры (здесь можно указать несколько файлов).</p>
<h2 id="рисуем-спрайт-на-экране">Рисуем спрайт на экране</h2>
<p>Первая программа будет совсем простой - мы нарисуем спрайт рыцаря в центре экрана. (Спрайт я взял вот с <a href="http://8bitcity.blogspot.com/2011/12/pixel-art-tiny-sprites.html">этой</a> страницы).</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-TASM" data-lang="TASM"><span style="color:#75af00">OPTION</span> <span style="color:#111">BINARY</span>
<span style="color:#00a8c8">ALIGN</span> <span style="color:#111">OFF</span>
 
        <span style="color:#75af00">ld</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#ae81ff">28</span>      <span style="color:#75715e">;(4)</span>
        <span style="color:#75af00">ld</span> <span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">10</span>      <span style="color:#75715e">;(5)</span>
        <span style="color:#75af00">ld</span> <span style="color:#111">I</span><span style="color:#111">,</span><span style="color:#111">sp</span><span style="color:#111">rite</span>   <span style="color:#75715e">;(6)</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>  <span style="color:#75715e">;(7)</span>
       
<span style="color:#111">loop:</span>                 <span style="color:#75715e">;(9)</span>
        <span style="color:#75af00">jp</span> <span style="color:#111">loop</span>       <span style="color:#75715e">;(10)</span>
       
<span style="color:#111">sprite:</span>               <span style="color:#75715e">;(12)</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">......1.</span>  <span style="color:#75715e">;(13)</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111.1</span><span style="color:#111">.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111111</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111.1</span><span style="color:#111">.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">.1111...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1...</span>  <span style="color:#75715e">;(24)</span>
</code></pre></div><p>Сохраняем данный код в файл с именем <strong>sprite.asm</strong> и компилируем командой:</p>
<pre><code>chipper sprite.c8 sprite.asm
</code></pre><p>Запустив sprite.c8 в эмуляторе мы увидим рыцаря.</p>
<p><img src="../../images/writing-chip-8-emulator-part-3/knight.png#c" alt="Изображение рыцаря в эмуляторе"></p>
<p>Теперь разберем код программы построчно.
Две первые строчки указывают Chipper'у создавать бинарный файл и не использовать выравнивание. Данные строки будут во всех наших программах.</p>
<p>В строке (4) мы загружаем в регистр V0 число 28, это будет значение координаты X.<br>
В (5) точно так загружаем координату Y в регистр V1.<br>
Строка (6) загружает адрес спрайта в регистр I. Адрес мы указываем в качестве метки sprite: которая находится на (12) строке.</p>
<p>В (7) строке рисуется спрайт по координатам лежащим в регистрах V0 и V1. Высота спрайта равна 12 пикселей (как вы помните из первой статьи, высота спрайта для CHIP-8 может варьироваться от 1 до 15 пикселей, для Super CHIP до 16).</p>
<p>В строках (9) и (10) мы создаем бесконечный цикл, что бы программа не завершилась.</p>
<p>Начиная от (13) и по (24) строку располагаются 12 байт представляющих спрайт рыцаря. Записаны они в двоичном виде(на что указывает символ $), где символ &ldquo;1&rdquo; обозначает установленный бит, символ &ldquo;.&rdquo; неустановленный (вместо точки можно использовать ноль). Установленные биты рисуются на экране.</p>
<h2 id="клавиатура-подпрограммы-перерисовка-спрайтов">Клавиатура, подпрограммы, перерисовка спрайтов</h2>
<p>В следующей программе можно перемещать спрайт по экрану используя клавиатуру.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-TASM" data-lang="TASM"><span style="color:#75af00">OPTION</span> <span style="color:#111">BINARY</span>
<span style="color:#00a8c8">ALIGN</span> <span style="color:#111">OFF</span>
 
        <span style="color:#75af00">ld</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#ae81ff">28</span>
        <span style="color:#75af00">ld</span> <span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">10</span>
        <span style="color:#75af00">ld</span> <span style="color:#111">I</span><span style="color:#111">,</span><span style="color:#111">sp</span><span style="color:#111">rite</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>    <span style="color:#75715e">;рисуем спрайт в центре экрана</span>
       
        <span style="color:#75af00">ld</span> <span style="color:#111">v4</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span>        <span style="color:#75715e">;регистр v4 будем использовать для изменения координаты на 1 пиксель</span>
 
<span style="color:#111">loop:</span>
        <span style="color:#75af00">ld</span> <span style="color:#111">v3</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span>        <span style="color:#75715e">;в регистре v3 сохраняем номер клавиши</span>
        <span style="color:#75af00">sknp</span> <span style="color:#111">v3</span>         <span style="color:#75715e">;пропускаем следующую инструкцию если эта клавиша не нажата</span>
        <span style="color:#75af00">call</span> <span style="color:#111">up</span>         <span style="color:#75715e">;если клавиша оказалась нажата, то вызываем подпрограмму up</span>
       
        <span style="color:#75af00">ld</span> <span style="color:#111">v3</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span>        <span style="color:#75715e">;остальное подобно предыдущему блоку</span>
        <span style="color:#75af00">sknp</span> <span style="color:#111">v3</span>
        <span style="color:#75af00">call</span> <span style="color:#111">down</span>
       
        <span style="color:#75af00">ld</span> <span style="color:#111">v3</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span>
        <span style="color:#75af00">sknp</span> <span style="color:#111">v3</span>
        <span style="color:#75af00">call</span> <span style="color:#111">left</span>
       
        <span style="color:#75af00">ld</span> <span style="color:#111">v3</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span>
        <span style="color:#75af00">sknp</span> <span style="color:#111">v3</span>
        <span style="color:#75af00">call</span> <span style="color:#111">right</span>
       
        <span style="color:#75af00">jp</span> <span style="color:#111">loop</span>
       
<span style="color:#111">up:</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>    <span style="color:#75715e">;стираем спрайт</span>
        <span style="color:#75af00">sub</span> <span style="color:#111">v1</span><span style="color:#111">,</span> <span style="color:#111">v4</span>      <span style="color:#75715e">;вычисляем новую координату</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>    <span style="color:#75715e">;рисуем спрайт на новом месте</span>
        <span style="color:#75af00">ret</span>             <span style="color:#75715e">;возвращаемся из подпрограммы в место вызова</span>
       
<span style="color:#111">down:</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>    <span style="color:#75715e">;подобно функции up</span>
        <span style="color:#75af00">add</span> <span style="color:#111">v1</span><span style="color:#111">,</span> <span style="color:#111">v4</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>
        <span style="color:#75af00">ret</span>
 
<span style="color:#111">left:</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>
        <span style="color:#75af00">sub</span> <span style="color:#111">v0</span><span style="color:#111">,</span> <span style="color:#111">v4</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>
        <span style="color:#75af00">ret</span>
       
<span style="color:#111">right:</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>
        <span style="color:#75af00">add</span> <span style="color:#111">v0</span><span style="color:#111">,</span> <span style="color:#111">v4</span>
        <span style="color:#75af00">drw</span> <span style="color:#111">v0</span><span style="color:#111">,</span><span style="color:#111">v1</span><span style="color:#111">,</span><span style="color:#ae81ff">12</span>
        <span style="color:#75af00">ret</span>
       
<span style="color:#111">sprite:</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">......1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111.1.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111.1</span><span style="color:#111">.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111111</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#ae81ff">11111.1</span><span style="color:#111">.</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">.1111...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..111...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1...</span>
        <span style="color:#00a8c8">db</span> <span style="color:#00a8c8">$</span><span style="color:#111">..1.1...</span>
</code></pre></div><p>Все необходимые комментарии есть в коде программы. Хочу упомянуть лишь о том, что графика на экран выводится методом XOR. Это означает, что если в определенной точке экрана нарисован пиксель, и мы рисуем его в этом же месте снова, то пиксель стирается! Таким образом, что бы стереть спрайт с экрана, нам необходимо нарисовать его еще раз в том же самом месте, что мы и делаем в первой строчке функций up, down, left и right.</p>
<h2 id="заготовка-для-небольшой-игры">Заготовка для небольшой игры</h2>
<p>В следующей программе я реализовал небольшую заготовку для игры наподобие Space Invaders. В ней инопланетный захватчик перемещается вправо-влево. Нажимая клавиши 4 и 6 мы так же можем перемещать наш корабль. Но стрелять наш корабль пока не умеет, я думаю вы сможете сами написать код для реализации стрельбы, если захотите.</p>
<p><img src="../../images/writing-chip-8-emulator-part-3/space-invaders.png#c" alt="Изображение space invaders"></p>
<p>Я не буду размещать в статье весь код этой программы, посмотреть его вы можете по ссылке <a href="http://pastebin.com/HaZYN5j6">http://pastebin.com/HaZYN5j6</a>
В строке (13) мы включаем режим Super CHIP.
Спрайт invader'а имеет размер16x16 пикселей(поэтому последний параметр команды drw равен нулю), спрайт корабля 8x8.
Для передвижения invader'а мы используем таймер задержки. Когда таймер обнулен, мы сдвигаем спрайт и снова устанавливаем таймер. Изменяя начальное значение таймера можно регулировать скорость перемещения спрайта.
Если вы хотите реализовать стрельбу, то помните: что бы определить столкновение двух спрайтов, необходимо проверять регистр VF, при столкновении он будет установлен в 1.</p>
<p><em>В сегодняшней статье мы не рассмотрели некоторые возможности CHIP-8, наподобие встроенных шрифтов и скроллинга экрана, но в них нет ничего сложного, вы и сами легко в этом разберетесь. Ну, а в <a href="/post/writing-chip-8-emulator-part-4-kernel/">следующей статье</a> мы перейдем непосредственно к написанию эмулятора.</em></p>
      
      
      <div class="related">

<h3>Похожие статьи:</h3>
<ul>
	
	<li><a href="/post/writing-chip-8-emulator-part-2/">Пишем эмулятор CHIP-8. Часть 2: Ассемблер</a></li>
	
	<li><a href="/post/writing-chip-8-emulator-part-1-intro/">Пишем эмулятор CHIP-8. Часть 1: Введение</a></li>
	
	<li><a href="/post/lazyips-patcher/">Lazy IPS</a></li>
	
	<li><a href="/post/sega-mega-drive-fix-checksum/">Sega Mega Drive Fix Checksum</a></li>
	
</ul>

</div>
      
    </div>
  </div>
</section>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <div id="show_comments"><a id="load_comments" class="button is-link">Показать комментарии</a></div>
  
    <script type="text/javascript">
      var disqus_shortname = 'emunix';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      
      var hash = window.location.hash.substr(1);
      if ((hash.length > 8) && (hash.substring(0, 8) === "comment-")) {
        disqus();
        document.getElementById("show_comments").style.display = "none";
      } else {
        document.getElementById('load_comments').onclick = function() {
          disqus();
          document.getElementById("show_comments").style.display = "none";
        };
      }
  

    </script>
    <noscript>Пожалуйста, включите JavaScript, что бы посмотреть <a href="https://disqus.com/?ref_noscript" rel="nofollow">комментарии</a>.</noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>© 2011-2020, <a href="mailto:btimofeev@emunix.org">Борис Тимофеев</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-28744527-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

